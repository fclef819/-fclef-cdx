name: Release and Publish

on:
  push:
    tags:
      - "v*"

jobs:
  release_and_publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Release作成に必要
      id-token: write   # npm Trusted publishing(OIDC)に必要

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v5
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"

      - run: npm ci

      # タグ(v1.2.3)と package.json の version(1.2.3)が一致しないと止める
      - name: Check tag matches package version
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          echo "tag=$TAG pkg=$PKG_VERSION"
          test "$TAG" = "$PKG_VERSION"

      - run: npm test --if-present
      - run: npm run build --if-present

      # GitHub Releaseを自動作成（タグを元に）
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false

      # npm publish（OIDCで認証される）
      - name: Publish to npm
        run: npm publish
